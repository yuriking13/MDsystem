name: Deploy MDsystem

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            cd /root/MDsystem
            git fetch --all
            git reset --hard origin/main

            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm install

            pnpm --filter api build
            pnpm --filter web build

            mkdir -p /etc/systemd/system/thesis-api.service.d

            # Пишем drop-in гарантированно без BOM/CRLF/отступов и с корректными кавычками systemd
            printf "%s\n" \
              "[Service]" \
              "Environment=\"JWT_SECRET=${{ secrets.JWT_SECRET }}\"" \
              "Environment=\"CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}\"" \
              "Environment=\"CROSSREF_MAILTO=${{ secrets.CROSSREF_MAILTO }}\"" \
              "Environment=\"API_KEY_ENCRYPTION_SECRET=${{ secrets.API_KEY_ENCRYPTION_SECRET }}\"" \
              "Environment=\"DATABASE_URL=postgresql://${{ secrets.PG_USER }}:${{ secrets.PG_PASSWORD }}@${{ secrets.PG_HOST }}:${{ secrets.PG_PORT }}/${{ secrets.PG_DATABASE }}\"" \
              > /etc/systemd/system/thesis-api.service.d/override.conf

            # На всякий случай убиваем дефолтный Beget hello-world (если вдруг снова появился)
            sudo -u nodejs pm2 delete hello-world || true
            sudo -u nodejs pm2 save || true

            cp /root/MDsystem/deploy/thesis-api.service /etc/systemd/system/thesis-api.service
            systemctl daemon-reload
            systemctl daemon-reexec
            systemctl restart thesis-api

            # Диагностика: покажи, что systemd реально видит нужные env (без вывода секретов целиком)
            systemctl show thesis-api -p Environment

            # frontend
            mkdir -p /var/www/thesis/web
            rm -rf /var/www/thesis/web/*
            cp -r /root/MDsystem/apps/web/dist/* /var/www/thesis/web/

            nginx -t
            systemctl reload nginx

            # Smoke check (если не поднялся — сразу падаем)
            systemctl is-active --quiet thesis-api
            curl -fsS http://127.0.0.1:3000/api/health >/dev/null

            echo "DEPLOY OK"
