name: Deploy MDsystem

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          command_timeout: 15m
          script: |
            set -euo pipefail

            cd /root/MDsystem
            git fetch --all
            git reset --hard origin/main

            corepack enable
            corepack prepare pnpm@9.15.0 --activate
            pnpm install --frozen-lockfile

            pnpm --filter api exec prisma generate

            pnpm --filter api build
            pnpm --filter web build

            export DATABASE_URL="postgresql://${{ secrets.PG_USER }}:${{ secrets.PG_PASSWORD }}@${{ secrets.PG_HOST }}:${{ secrets.PG_PORT }}/${{ secrets.PG_DATABASE }}"

            apply_migration() {
              local migration_file="$1"
              echo "Applying migration: $(basename "$migration_file")"
              psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$migration_file"
            }

            apply_migration /root/MDsystem/apps/api/prisma/migrations/reset_boss_schema.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/drop_admin_views.sql

            echo "Generating Prisma schema diff (dry-run, informational only)..."
            if ! pnpm --filter api exec prisma migrate diff --from-url "$DATABASE_URL" --to-schema-datamodel /root/MDsystem/apps/api/prisma/schema.prisma --script > /tmp/prisma-diff.sql; then
              echo "WARNING: Prisma diff generation failed (non-critical)." >&2
            fi

            echo "Skipping prisma db push (manual DB mode)."

            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_project_files.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_file_extracted_metadata.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/fix_admin_user.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_user_blocking.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_password_reset_tokens.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_project_settings.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_auto_graph_sync_setting.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_semantic_search.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_semantic_clusters.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_embedding_jobs.sql
            apply_migration /root/MDsystem/apps/api/prisma/migrations/add_refresh_tokens.sql

            JWT_SECRET='${{ secrets.JWT_SECRET }}'
            ENC_SECRET='${{ secrets.API_KEY_ENCRYPTION_SECRET }}'

            echo "JWT_SECRET length: ${#JWT_SECRET}"
            echo "API_KEY_ENCRYPTION_SECRET length: ${#ENC_SECRET}"

            test ${#JWT_SECRET} -ge 20 || { echo "ERROR: JWT_SECRET too short"; exit 2; }
            test ${#ENC_SECRET} -ge 32 || { echo "ERROR: ENC_SECRET too short"; exit 2; }

            mkdir -p /etc/systemd/system/thesis-api.service.d

            printf "[Service]\nEnvironment=\"NODE_ENV=production\"\nEnvironment=\"PORT=3000\"\nEnvironment=\"HOST=127.0.0.1\"\nEnvironment=\"JWT_SECRET=${{ secrets.JWT_SECRET }}\"\nEnvironment=\"CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}\"\nEnvironment=\"CROSSREF_MAILTO=${{ secrets.CROSSREF_MAILTO }}\"\nEnvironment=\"API_KEY_ENCRYPTION_SECRET=${{ secrets.API_KEY_ENCRYPTION_SECRET }}\"\nEnvironment=\"METRICS_SCRAPE_TOKEN=${{ secrets.METRICS_SCRAPE_TOKEN }}\"\nEnvironment=\"DATABASE_URL=postgresql://${{ secrets.PG_USER }}:${{ secrets.PG_PASSWORD }}@${{ secrets.PG_HOST }}:${{ secrets.PG_PORT }}/${{ secrets.PG_DATABASE }}\"\nEnvironment=\"S3_ENDPOINT=${{ secrets.S3_ENDPOINT }}\"\nEnvironment=\"S3_REGION=${{ secrets.S3_REGION }}\"\nEnvironment=\"S3_ACCESS_KEY_ID=${{ secrets.S3_ACCESS_KEY_ID }}\"\nEnvironment=\"S3_SECRET_ACCESS_KEY=${{ secrets.S3_SECRET_ACCESS_KEY }}\"\nEnvironment=\"S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}\"\n" > /etc/systemd/system/thesis-api.service.d/override.conf

            cp /root/MDsystem/deploy/thesis-api.service /etc/systemd/system/thesis-api.service
            systemctl daemon-reload
            systemctl daemon-reexec
            systemctl restart thesis-api

            mkdir -p /var/www/thesis/web
            rm -rf /var/www/thesis/web/*
            cp -r /root/MDsystem/apps/web/dist/* /var/www/thesis/web/

            cp /root/MDsystem/deploy/nginx.conf /etc/nginx/sites-available/thesis.conf
            ln -sf /etc/nginx/sites-available/thesis.conf /etc/nginx/sites-enabled/thesis.conf
            rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            rm -f /etc/nginx/sites-enabled/nodejs 2>/dev/null || true

            nginx -t
            systemctl reload nginx

            sleep 5
            curl -fsS http://127.0.0.1:3000/api/health >/dev/null 2>&1 || sleep 5
            curl -fsS http://127.0.0.1:3000/api/health >/dev/null 2>&1 || sleep 5
            curl -fsS http://127.0.0.1:3000/api/health >/dev/null 2>&1 || { echo "HEALTH CHECK FAILED after 15s"; journalctl -u thesis-api --no-pager -n 30; exit 1; }
            echo "HEALTH OK"
            echo "DEPLOY OK"
