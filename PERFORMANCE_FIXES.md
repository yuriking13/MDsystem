# Исправления производительности

## Выполнено

### 1. Исправлено автосохранение таблиц
**Проблема:** Обработчик `editor.on('update')` срабатывал на каждое изменение документа и пытался сохранить все таблицы
**Решение:** 
- Убрали автоматический обработчик на событие `update`
- Создали глобальную функцию `__editorCreateTable`, которая срабатывает только при создании таблицы через toolbar
- Теперь сохранение происходит только один раз при создании

### 2. Исправлена проблема дубликатов при импорте
**Проблема:** Таблицы импортированные из Статистики создавали дубликаты
**Решение:**
- Импортированные таблицы уже имеют `data-statistic-id`
- Новый механизм проверяет наличие атрибута и не сохраняет такие таблицы повторно

### 3. Включен ресайз таблиц
**Проблема:** Ресайз колонок не работал
**Решение:**
- Добавлен параметр `lastColumnResizable: true`
- Улучшен CSS для `.column-resize-handle` - сделан полупрозрачным (opacity: 0.3) вместо невидимого
- Улучшена видимость при hover и drag

### 4. Возможность удалять поврежденные статистики
**Проблема:** Статистики с невалидным ID не удалялись
**Решение:**
- При попытке удаления невалидной записи предлагается локальное удаление из списка
- Добавлена SQL миграция для очистки БД от невалидных записей

## Запуск миграции очистки

```bash
cd /workspaces/MDsystem/apps/api
psql $DATABASE_URL -f prisma/migrations/cleanup_invalid_statistics.sql
```

## Дополнительные рекомендации по производительности

### Отключить debounce для автосохранения (если нужно)
В `DocumentPage.tsx` можно добавить debounce для `setContent`:

```typescript
const debouncedSetContent = useMemo(
  () => debounce((value: string) => setContent(value), 500),
  []
);
```

### Оптимизация рендеринга таблиц
- TipTap использует виртуальный DOM - большая часть оптимизации уже сделана
- Избегайте создания больших таблиц (>50 строк) в документе

### Мониторинг производительности
Откройте Chrome DevTools → Performance → Record для анализа узких мест
